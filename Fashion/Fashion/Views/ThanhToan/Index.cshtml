@model Fashion.ViewModels.ThanhToanViewModel
@using System.Globalization
@{
    ViewData["Title"] = "X√°c Nh·∫≠n Thanh To√°n";
    var culture = new CultureInfo("vi-VN");
    Layout = "~/Views/Shared/_Layout.cshtml"; // ƒê·∫£m b·∫£o c√≥ file layout d√πng chung
}
@section Styles {
    <link rel="stylesheet" href="~/css/Xacnhanthanhtoan.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
}

<form id="checkout-form" asp-controller="ThanhToan" asp-action="PlaceOrder" method="post">
    @Html.AntiForgeryToken()
    <div class="main-container fade-in">
        <!-- Left Panel -->
        <div class="left-panel">
            <div class="header">
                <h1>X√°c Nh·∫≠n Thanh To√°n</h1>
                <p>Ho√†n t·∫•t th√¥ng tin ƒë·ªÉ ti·∫øn h√†nh thanh to√°n an to√†n</p>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step">
                    <div class="step-number completed">‚úì</div>
                    <div class="step-text">Gi·ªè h√†ng</div>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-text">Thanh to√°n</div>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <div class="step-number inactive">3</div>
                    <div class="step-text">Ho√†n t·∫•t</div>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="section">
                <div class="section-header">
                    <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <h2 class="section-title">Th√¥ng Tin Kh√°ch H√†ng</h2>
                </div>

                <div class="contact-info">
                    <h3>Th√¥ng tin li√™n l·∫°c</h3>
                    <div class="input-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-input" placeholder="example@email.com" />
                    </div>
                </div>
                <div class="shipping-address">
                    <h3>ƒê·ªãa ch·ªâ giao h√†ng</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label asp-for="HoTen" class="form-label">H·ªç v√† T√™n</label>
                            <input asp-for="HoTen" class="form-input" required />
                            <span asp-validation-for="HoTen" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="SoDienThoai" class="form-label">S·ªë ƒêi·ªán Tho·∫°i</label>
                            <input asp-for="SoDienThoai" class="form-input" required />
                            <span asp-validation-for="SoDienThoai" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label asp-for="DiaChiGiaoHang" class="form-label">ƒê·ªãa ch·ªâ giao h√†ng</label>
                        <input asp-for="DiaChiGiaoHang" class="form-input" required />
                        <span asp-validation-for="DiaChiGiaoHang" class="text-danger"></span>
                    </div>
                    <div class="form-group full-width">
                        <label asp-for="GhiChu" class="form-label">Ghi ch√∫ (t√πy ch·ªçn)</label>
                        <textarea asp-for="GhiChu" rows="3" class="form-input"></textarea>
                    </div>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="section">
                <div class="section-header">
                    <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    <h2 class="section-title">Ph∆∞∆°ng Th·ª©c Thanh To√°n</h2>
                </div>

                <input type="hidden" asp-for="PhuongThucThanhToan" id="PhuongThucThanhToan" />
                <span asp-validation-for="PhuongThucThanhToan" class="text-danger"></span>

                <div class="payment-methods">
                    <div class="payment-option" onclick="selectPayment(this, 'Th·∫ª T√≠n D·ª•ng')">
                        <input type="radio" name="payment" value="Th·∫ª T√≠n D·ª•ng" />
                        <div class="payment-icon">üí≥</div>
                        <div class="payment-name">Th·∫ª T√≠n D·ª•ng</div>
                        <div class="payment-desc">Visa, Mastercard</div>
                    </div>
                    <div class="payment-option" onclick="selectPayment(this, 'Chuy·ªÉn Kho·∫£n')">
                        <input type="radio" name="payment" value="Chuy·ªÉn Kho·∫£n" />
                        <div class="payment-icon">üè¶</div>
                        <div class="payment-name">Chuy·ªÉn Kho·∫£n</div>
                        <div class="payment-desc">Ng√¢n h√†ng n·ªôi ƒë·ªãa</div>
                    </div>
                    <div class="payment-option" onclick="selectPayment(this, 'V√≠ ƒêi·ªán T·ª≠')">
                        <input type="radio" name="payment" value="V√≠ ƒêi·ªán T·ª≠" />
                        <div class="payment-icon">üì±</div>
                        <div class="payment-name">V√≠ ƒêi·ªán T·ª≠</div>
                        <div class="payment-desc">Thanh to√°n nhanh</div>
                    </div>
                    <div class="payment-option" onclick="selectPayment(this, 'Ti·ªÅn M·∫∑t')">
                        <input type="radio" name="payment" value="Ti·ªÅn M·∫∑t" />
                        <div class="payment-icon">üí∞</div>
                        <div class="payment-name">Ti·ªÅn M·∫∑t</div>
                        <div class="payment-desc">Thanh to√°n khi nh·∫≠n h√†ng</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="order-info-card">
                <div class="order-info-header">Th√¥ng Tin ƒê∆°n H√†ng</div>
                <div class="order-detail"><span>M√£ ƒë∆°n h√†ng:</span> <strong>@Model.NewOrderId</strong></div>
                <div class="order-detail"><span>Ng√†y ƒë·∫∑t:</span> <strong>@Model.OrderDate.ToString("dd/MM/yyyy")</strong></div>
                <div class="order-detail"><span>Tr·∫°ng th√°i:</span> <strong>Ch·ªù thanh to√°n</strong></div>
            </div>

            <div class="order-summary">
                <div class="summary-header">
                    <svg class="cart-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="..."></path>
                    </svg>
                    T√≥m T·∫Øt ƒê∆°n H√†ng
                </div>

                @foreach (var item in Model.CartItems)
                {
                    var price = item.KichThuocSanPham.SanPham.GiaGiam.HasValue && item.KichThuocSanPham.SanPham.GiaGiam < item.KichThuocSanPham.SanPham.Gia
                                ? item.KichThuocSanPham.SanPham.GiaGiam.Value
                                : item.KichThuocSanPham.SanPham.Gia;
                    <div class="order-item">
                        <div class="item-info">
                            <div class="item-name">@item.KichThuocSanPham.SanPham.Ten</div>
                            <div class="item-details">S·ªë l∆∞·ª£ng: @item.SoLuong</div>
                        </div>
                        <div class="item-price">@((item.SoLuong * price).ToString("N0", culture)) VNƒê</div>
                    </div>
                }

                <div class="summary-totals">
                    <div class="total-row final"><span>T·ªïng c·ªông:</span> <span>@Model.Total.ToString("N0", culture) VNƒê</span></div>
                </div>
            </div>

            <button type="submit" class="confirm-button">X√°c Nh·∫≠n Thanh To√°n @Model.Total.ToString("N0", culture) VNƒê</button>

            <div class="security-badge">
                <svg class="security-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="..."></path>
                </svg>
                Thanh to√°n ƒë∆∞·ª£c b·∫£o m·∫≠t b·∫±ng SSL 256-bit
            </div>
        </div>
    </div>
</form>

<!-- Success Modal -->
<div id="success-modal-overlay" class="modal-overlay">
    <div class="success-modal">
        <div class="checkmark"></div>
        <h2>Thanh To√°n Th√†nh C√¥ng</h2>
        <p>ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n. Ki·ªÉm tra email c·ªßa b·∫°n ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.</p>
        <div class="modal-buttons">
            <button id="go-to-homepage-btn" class="modal-btn primary">V·ªÅ Trang Ch·ªß</button>
            <button id="check-order-btn" class="modal-btn secondary">Xem ƒê∆°n H√†ng</button>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            document.getElementById('NgayThanhToan').valueAsDate = new Date();
            
            // Select the first payment option by default
            const firstPaymentOption = document.querySelector('.payment-option');
            if(firstPaymentOption) {
                selectPayment(firstPaymentOption, firstPaymentOption.querySelector('input').value);
            }

             // Add smooth animations
            const elements = document.querySelectorAll('.section, .order-summary, .order-info-card, .step');
            elements.forEach((el, index) => {
                el.style.animationDelay = `${index * 0.1}s`;
                el.classList.add('fade-in');
            });
        });

        function selectPayment(element, method) {
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            element.classList.add('selected');
            element.querySelector('input[type="radio"]').checked = true;
            document.getElementById('PhuongThucThanhToan').value = method;
        }

        document.getElementById('checkout-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = this;
            if (!form.checkValidity()) {
                form.reportValidity();
                const firstInvalid = form.querySelector(':invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                }
                return;
            }
            
            const selectedPayment = document.querySelector('input[name="payment"]:checked');
            if (!selectedPayment) {
                alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!');
                return;
            }

            const button = document.querySelector('.confirm-button');
            button.classList.add('processing');
            button.innerHTML = '<div class="loading-spinner"></div>ƒêang x·ª≠ l√Ω...';
            button.disabled = true;

            const formData = new FormData(this);
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': token
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.classList.remove('processing');
                    button.classList.add('success');
                    button.innerHTML = '‚úì Thanh to√°n th√†nh c√¥ng!';
                    
                    document.querySelectorAll('.step-number')[1].classList.add('completed');
                    document.querySelectorAll('.step-number')[1].innerHTML = '‚úì';
                    document.querySelectorAll('.step-number')[2].classList.remove('inactive');
                    
                    document.getElementById('success-modal-overlay').classList.add('visible');

                } else {
                    button.classList.remove('processing');
                    button.innerHTML = `X√°c Nh·∫≠n Thanh To√°n @Model.Total.ToString("N0", culture) VNƒê`;
                    button.disabled = false;
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.');
                }
            }).catch(error => {
                button.classList.remove('processing');
                button.innerHTML = `X√°c Nh·∫≠n Thanh To√°n @Model.Total.ToString("N0", culture) VNƒê`;
                button.disabled = false;
                console.error('L·ªói Fetch:', error);
                alert('ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin v√† th·ª≠ l·∫°i.');
            });
        });

        document.getElementById('go-to-homepage-btn').addEventListener('click', function() {
            window.location.href = '/';
        });

        document.getElementById('check-order-btn').addEventListener('click', function() {
            window.location.href = '/Account/OrderHistory';
        });

        document.getElementById('SoDienThoai').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            e.target.value = value;
        });
    </script>
} 